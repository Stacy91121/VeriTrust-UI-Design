<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeriTrust - Secure Identity Platform</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- Landing/Auth Section -->
    <div id="auth-section" class="container">
        <header class="text-center mb-lg">
            <!-- Replace header title with brand + logo -->
            <div class="brand brand-lg center">
                <img src="photos/VTLogo.svg" alt="VeriTrust logo" />
                <h1 class="brand-text">VeriTrust</h1>
            </div>
            <p style="font-size: 1.2rem; color: var(--text-secondary);">Secure Identity. Trusted Community.</p>
        </header>

        <!-- Login Section -->
        <main id="login-section" class="auth-section">
            <h2>Welcome Back</h2>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group password-field">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                    <button type="button" class="toggle-visibility" onclick="togglePassword('password', this)">üëÅÔ∏è</button>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Log In</button>
                <a href="#" class="forgot-password">Forgot Password?</a>
            </form>
            
            <div class="auth-switch">
                <div class="auth-switch-text">Don't have an account?</div>
                <button class="auth-switch-btn" onclick="showSignup()">Sign up here</button>
            </div>
        </main>

        <!-- Signup Section -->
        <main id="signup-section" class="auth-section hidden">
            <h2>Create Account</h2>
            <div class="verification-notice" style="margin-bottom: var(--spacing-lg);">
                <span>üîí</span>
                <span>Account verification through secure bank connection required</span>
            </div>
            <form onsubmit="signup(event)">
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" required>
                </div>
                <div class="form-group">
                    <label for="signup-first-name">First Name</label>
                    <input type="text" id="signup-first-name" required>
                </div>
                <div class="form-group">
                    <label for="signup-last-name">Last Name</label>
                    <input type="text" id="signup-last-name" required>
                </div>
                <div class="form-group">
                    <label for="signup-phone">Phone Number</label>
                    <input type="tel" id="signup-phone" placeholder="(555) 555-5555" required>
                </div>
                <div class="form-group password-field">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" required>
                    <button type="button" class="toggle-visibility" onclick="togglePassword('signup-password', this)">üëÅÔ∏è</button>
                </div>
                <div class="form-group password-field">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" required>
                    <button type="button" class="toggle-visibility" onclick="togglePassword('confirm-password', this)">üëÅÔ∏è</button>
                </div>
                <div style="display: flex; align-items: flex-start; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                    <input type="checkbox" id="terms" required style="width: auto; margin-top: 2px;">
                    <label for="terms">I agree to use trusted bank verification</label>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Create Account</button>
            </form>
            
            <div class="auth-switch">
                <div class="auth-switch-text">Already have an account?</div>
                <button class="auth-switch-btn" onclick="showLogin()">Sign in here</button>
            </div>
        </main>
    </div>

    <!-- Verification Section -->
    <div id="verification-section" class="container" style="display: none;">
        <header class="verification-header">
            <div class="logo">VeriTrust</div>
            <div class="progress-stepper">
                <div class="step completed">1. Create Account</div>
                <div class="step active">2. Verify Identity</div>
                <div class="step">3. Complete</div>
            </div>
        </header>

        <main class="verification-container">
            <div id="verification-start" class="verification-step active">
                <div class="verification-card">
                    <div class="icon-large">üè¶</div>
                    <h2>Verify Your Identity</h2>
                    <p>Provide your bank information to verify your identity. This creates a trusted profile for community interactions.</p>
                    
                    <div class="security-features">
                        <div class="feature">
                            <span class="icon">üîí</span>
                            <span>Bank-grade security</span>
                        </div>
                        <div class="feature">
                            <span class="icon">üö´</span>
                            <span>No account access</span>
                        </div>
                        <div class="feature">
                            <span class="icon">‚úì</span>
                            <span>One-time verification</span>
                        </div>
                    </div>

                    <button class="btn-primary" onclick="showBankForm()">Connect Your Bank</button>
                    <button class="btn-secondary" onclick="skipVerification()">Skip for Now</button>
                </div>
            </div>

            <div id="verification-form" class="verification-step">
                <div class="verification-card">
                    <div class="icon-large">üè¶</div>
                    <h2>Bank Information Verification</h2>
                    <p>Please provide the following information to verify your identity:</p>
                    
                    <form id="bankVerificationForm" class="bank-form">
                        <div class="form-group">
                            <label for="bank-name">Bank Name *</label>
                            <select id="bank-name" required>
                                <option value="">Select your bank</option>
                                <option value="chase">Chase Bank</option>
                                <option value="bofa">Bank of America</option>
                                <option value="wells">Wells Fargo</option>
                                <option value="citi">Citibank</option>
                                <option value="usbank">US Bank</option>
                                <option value="pnc">PNC Bank</option>
                                <option value="td">TD Bank</option>
                                <option value="capital">Capital One</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="account-month">Account Opened Month *</label>
                                <select id="account-month" required>
                                    <option value="">Month</option>
                                    <option value="01">January</option>
                                    <option value="02">February</option>
                                    <option value="03">March</option>
                                    <option value="04">April</option>
                                    <option value="05">May</option>
                                    <option value="06">June</option>
                                    <option value="07">July</option>
                                    <option value="08">August</option>
                                    <option value="09">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="account-year">Account Opened Year *</label>
                                <select id="account-year" required>
                                    <option value="">Year</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="account-type">Account Type *</label>
                            <select id="account-type" required>
                                <option value="">Select account type</option>
                                <option value="checking">Checking</option>
                                <option value="savings">Savings</option>
                                <option value="both">Both Checking & Savings</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="zip-code">ZIP Code (where account was opened) *</label>
                            <input type="text" id="zip-code" maxlength="5" pattern="[0-9]{5}" placeholder="12345" required>
                        </div>

                        <div class="form-group">
                            <label for="routing-number">Bank Routing Number *</label>
                            <input type="text" id="routing-number" maxlength="9" pattern="[0-9]{9}" placeholder="123456789" required>
                        </div>

                        <div class="form-group">
                            <label for="phone-last4">Last 4 digits of phone number *</label>
                            <input type="text" id="phone-last4" maxlength="4" pattern="[0-9]{4}" placeholder="1234" required>
                        </div>

                        <div class="verification-notice">
                            <span class="icon">üîí</span>
                            Your information is encrypted and used only for identity verification
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="showVerificationStep('verification-start')">Back</button>
                            <button type="submit" class="btn-primary">Verify Identity</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Verification (auto-run for most logins) -->
            <div id="quick-verification" class="verification-step">
                <div class="verification-card">
                    <div class="spinner"></div>
                    <h2>Quick Verification</h2>
                    <p>Performing quick checks to secure your session...</p>
                    <div class="status-indicator pending">In Progress</div>
                </div>
            </div>

            <div id="verification-pending" class="verification-step">
                <div class="verification-card">
                    <div class="spinner"></div>
                    <h2>Verifying...</h2>
                    <p>Please wait while we verify your identity through your bank connection.</p>
                    <div class="status-indicator pending">In Progress</div>
                </div>
            </div>

            <div id="verification-success" class="verification-step">
                <div class="verification-card">
                    <div class="icon-large success">‚úì</div>
                    <h2>Verification Successful!</h2>
                    <p>Your identity has been verified. You now have access to all VeriTrust community features.</p>
                    
                    <div class="verified-badge">
                        <span class="badge-icon">‚úì</span>
                        <span>Verified User</span>
                    </div>

                    <button class="btn-primary" onclick="goToDashboard()">Go to Dashboard</button>
                </div>
            </div>

            <div id="verification-failed" class="verification-step">
                <div class="verification-card">
                    <div class="icon-large error">‚ö†Ô∏è</div>
                    <h2>Verification Failed</h2>
                    <p>We couldn't verify your identity at this time. Please try again or contact support.</p>
                    
                    <div class="error-banner">
                        Unable to connect to your bank. Please check your credentials and try again.
                    </div>

                    <button class="btn-primary" onclick="retryVerification()">Try Again</button>
                    <button class="btn-secondary" onclick="contactSupport()">Contact Support</button>
                </div>
            </div>
        </main>
    </div>

    <!-- App Container -->
    <div id="app-section" class="app-container hidden">
        <nav class="sidebar">
            <!-- Replace sidebar brand text with brand + logo -->
            <div class="brand" style="margin-bottom: var(--spacing-xl);">
                <img src="photos/VTLogo.svg" alt="VeriTrust logo" />
                <span class="brand-text">VeriTrust</span>
            </div>
            <div class="nav-links">
                <a href="#" class="nav-link active" onclick="showPage('dashboard')">
                    <span>üè†</span>Dashboard
                </a>
                <a href="#" class="nav-link" onclick="showPage('securefind')">
                    <span>üîç</span>SecureFind
                </a>
                <a href="#" class="nav-link" onclick="showPage('easytask')">
                    <span>üìù</span>EasyTask
                </a>
                <a href="#" class="nav-link" onclick="showPage('messages')">
                    <span>üí¨</span>Messages
                </a>
                <a href="#" class="nav-link" onclick="showPage('profile')">
                    <span>üë§</span>Profile
                </a>
            </div>
        </nav>

        <!-- Page Content Container -->
        <div class="page-content">
            <header class="top-bar">
                <h1 id="page-title">Dashboard</h1>
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div class="verified-badge" id="verifiedBadge">
                        <span>‚úì</span>
                        <span>Verified</span>
                    </div>
                    <button onclick="showPage('notifications')">üîî</button>
                    <div class="user-menu">
                        <button class="user-avatar" id="userAvatarBtn" onclick="toggleUserMenu()">--</button>
                        <div id="userDropdown" class="user-dropdown hidden">
                            <button onclick="showPage('profile'); hideUserMenu()">üë§ Profile</button>
                            <button onclick="logout(); hideUserMenu()">üö™ Log Out</button>
                        </div>
                    </div>
                </div>
            </header>

            <main class="main-content" id="main-content">
                <!-- Dynamic content loaded here -->
            </main>
        </div>
    </div>

    <script>
        // Simplified state management
        const state = {
            currentUser: null,
            isVerified: false,
            currentPage: 'dashboard'
        };

        // Sample data for dashboard widgets (define early)
        const dashboardData = {
            recentSecureFindItems: [
                {
                    id: 'item1',
                    title: 'iPhone 15 Pro',
                    location: 'Downtown Coffee Shop',
                    status: 'lost',
                    time: new Date(Date.now() - 2 * 60 * 60 * 1000),
                    icon: 'üì±',
                    priority: 'high'
                },
                {
                    id: 'item2',
                    title: 'Blue Wallet',
                    location: 'Central Park',
                    status: 'found',
                    time: new Date(Date.now() - 6 * 60 * 60 * 1000),
                    icon: 'üí≥',
                    priority: 'medium'
                },
                {
                    id: 'item3',
                    title: 'Black Backpack',
                    location: 'University Campus',
                    status: 'lost',
                    time: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),
                    icon: 'üéí',
                    priority: 'low'
                },
                {
                    id: 'item4',
                    title: 'Reading Glasses',
                    location: 'Public Library',
                    status: 'found',
                    time: new Date(Date.now() - 4 * 60 * 60 * 1000),
                    icon: 'üëì',
                    priority: 'low'
                }
            ],
            upcomingTasks: [
                {
                    id: 'task1',
                    title: 'Review SecureFind matches',
                    description: 'Check potential matches and respond to messages',
                    dueDate: new Date(Date.now() + 2 * 60 * 60 * 1000),
                    priority: 'high',
                    completed: false
                },
                {
                    id: 'task2',
                    title: 'Complete profile verification',
                    description: 'Add additional verification details',
                    dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000),
                    priority: 'medium',
                    completed: false
                },
                {
                    id: 'task3',
                    title: 'Update contact information',
                    description: 'Verify phone number and address',
                    dueDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),
                    priority: 'low',
                    completed: false
                },
                {
                    id: 'task4',
                    title: 'Schedule dentist appointment',
                    description: 'Call office to book routine cleaning',
                    dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
                    priority: 'low',
                    completed: true
                }
            ]
        };

        // Sample notification data
        const notificationData = {
            notifications: [
                {
                    id: 'notif1',
                    type: 'match',
                    title: 'Potential Match Found',
                    text: 'Your lost iPhone 15 Pro may have been found! Sarah Johnson posted a matching item in Central Park.',
                    time: new Date(Date.now() - 10 * 60 * 1000),
                    read: false,
                    actionable: true
                },
                {
                    id: 'notif2',
                    type: 'message',
                    title: 'New Message',
                    text: 'Mike Chen sent you a message about the blue wallet you found.',
                    time: new Date(Date.now() - 2 * 60 * 60 * 1000),
                    read: false,
                    actionable: true
                },
                {
                    id: 'notif3',
                    type: 'task',
                    title: 'Task Reminder',
                    text: 'Don\'t forget to complete your profile verification.',
                    time: new Date(Date.now() - 6 * 60 * 60 * 1000),
                    read: true,
                    actionable: false
                }
            ]
        };

        // Sample message data
        const messageData = {
            contacts: [
                {
                    id: 'contact1',
                    name: 'Sarah Johnson',
                    preview: 'Thanks for helping me find my wallet!',
                    time: '2 min ago',
                    messages: [
                        { text: 'Hi! I saw your post about finding a blue wallet in Central Park', sent: false, time: '10:30 AM' },
                        { text: 'Yes! I found it near the fountain. Can you describe what was inside?', sent: true, time: '10:32 AM' },
                        { text: 'Perfect! That matches. When would you like to meet up?', sent: true, time: '10:35 AM' },
                        { text: 'Thanks for helping me find my wallet!', sent: false, time: '10:40 AM' }
                    ]
                }
            ],
            currentContact: null,
            availableContacts: [
                { id: 'new1', name: 'Emma Wilson', context: 'Posted about lost keys in downtown area' },
                { id: 'new2', name: 'David Lee', context: 'Found a wallet near the metro station' }
            ]
        };

        // Claim state
        const claimState = { itemId: null };

        // Utility functions
        const $ = id => document.getElementById(id);
        const show = el => el?.classList.remove('hidden');
        const hide = el => el?.classList.add('hidden');
        const toggle = el => el?.classList.toggle('hidden');

        // Cookie management
        function setCookie(name, value, days = 7) {
            const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toUTCString();
            document.cookie = `${name}=${JSON.stringify(value)};expires=${expires};path=/;SameSite=Strict`;
        }

        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? JSON.parse(match[2]) : null;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
        }

        // Storage helpers
        const getUser = () => JSON.parse(localStorage.getItem('veritrustUser') || '{}');
        const setUser = data => localStorage.setItem('veritrustUser', JSON.stringify(data));

        // Auth functions
        function showLogin() {
            hide($('signup-section'));
            show($('login-section'));
            // Clear signup form
            $('signup-section').querySelector('form').reset();
        }

        function showSignup() {
            hide($('login-section'));
            show($('signup-section'));
            // Clear login form
            $('login-section').querySelector('form').reset();
        }

        function login(e) {
            e.preventDefault();
            const email = $('email').value.trim();
            const password = $('password').value;
            const userData = getUser();
            
            if (!userData.email || userData.email !== email || userData.password !== password) {
                return alert('Invalid credentials');
            }
            
            state.currentUser = userData;
            setCookie('session', { email, verified: userData.verified });
            startApp();
        }

        function signup(e) {
            e.preventDefault();
            const email = $('signup-email').value.trim();
            const firstName = $('signup-first-name').value.trim();
            const lastName = $('signup-last-name').value.trim();
            const phone = $('signup-phone').value.trim();
            const password = $('signup-password').value;
            const confirmPassword = $('confirm-password').value;
            const terms = $('terms').checked;
            
            if (!email || !firstName || !lastName || !phone || !password || !confirmPassword) {
                return alert('Please fill in all fields');
            }
            
            if (password !== confirmPassword) {
                return alert('Passwords do not match');
            }
            
            if (!terms) {
                return alert('Please accept the terms');
            }
            
            if (getUser().email === email) {
                return alert('User already exists');
            }
            
            const userData = {
                email,
                firstName,
                lastName,
                phone,
                password,
                verified: false,
                signupDate: new Date().toISOString()
            };
            
            setUser(userData);
            alert('Account created! Please login.');
            showLogin();
            $('email').value = email; // Pre-fill email on login form
        }

        // Add missing verification functions
        function logout() {
            deleteCookie('session');
            state.currentUser = null;
            state.isVerified = false;
            hide($('app-section'));
            hide($('verification-section'));
            show($('auth-section'));
            showLogin();
        }

        function showBankForm() {
            showVerificationStep('verification-form');
            populateYearDropdown();
        }

        function populateYearDropdown() {
            const yearSelect = $('account-year');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '<option value="">Year</option>';
            
            for (let year = currentYear; year >= 1970; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        function showVerificationStep(stepId) {
            document.querySelectorAll('.verification-step').forEach(step => {
                step.classList.remove('active');
            });
            const targetStep = $(stepId);
            if (targetStep) {
                targetStep.classList.add('active');
            }
        }

        function skipVerification() {
            state.isVerified = false;
            goToDashboard();
        }

        function goToDashboard() {
            hide($('verification-section'));
            show($('app-section'));
            updateUserAvatar();
            showPage('dashboard');
        }

        function retryVerification() {
            showVerificationStep('verification-start');
        }

        function contactSupport() {
            alert('Support contact feature coming soon!');
        }

        // Fix claim modal event handling
        function openClaimModal(itemId) {
            claimState.itemId = itemId;
            const item = getItemById(itemId);
            
            // Reset all steps
            const steps = ['claimStepForm', 'claimStepPending', 'claimStepSuccess', 'claimStepFailed'];
            steps.forEach(stepId => {
                const step = $(stepId);
                if (step) step.style.display = 'none';
            });
            
            // Show form step
            const formStep = $('claimStepForm');
            if (formStep) formStep.style.display = 'block';

            // Prefill form
            const u = state.currentUser || getUser();
            const titleEl = $('claimItemTitle');
            const nameEl = $('claimFullName');
            const idNumberEl = $('claimIdNumber');
            const expEl = $('claimExp');
            const stateEl = $('claimState');
            const imageEl = $('claimIdImage');
            const confirmEl = $('claimConfirm');
            
            if (titleEl) titleEl.textContent = item ? item.title : 'Item';
            if (nameEl) nameEl.value = [u.firstName || '', u.lastName || ''].join(' ').trim();
            if (idNumberEl) idNumberEl.value = '';
            if (expEl) expEl.value = '';
            if (stateEl) stateEl.value = '';
            if (imageEl) imageEl.value = '';
            if (confirmEl) confirmEl.checked = false;

            // Show modal
            const modal = $('claimModal');
            if (modal) modal.classList.add('active');
        }

        function closeClaimModal() {
            const modal = $('claimModal');
            if (modal) modal.classList.remove('active');
        }

        function startClaimVerification(e) {
            e.preventDefault();
            
            const fullName = $('claimFullName')?.value?.trim();
            const issuingState = $('claimState')?.value;
            const idNum = $('claimIdNumber')?.value?.trim();
            const exp = $('claimExp')?.value;
            const image = $('claimIdImage')?.files?.[0];
            const confirmed = $('claimConfirm')?.checked;

            if (!fullName || !issuingState || !idNum || !exp || !image || !confirmed) {
                alert('Please complete all required fields and confirmations.');
                return;
            }

            // Show pending step
            const formStep = $('claimStepForm');
            const pendingStep = $('claimStepPending');
            if (formStep) formStep.style.display = 'none';
            if (pendingStep) pendingStep.style.display = 'block';

            // Simulate verification check
            setTimeout(() => {
                const success = Math.random() < 0.85; // 85% success rate
                const pendingStep = $('claimStepPending');
                const successStep = $('claimStepSuccess');
                const failedStep = $('claimStepFailed');
                
                if (pendingStep) pendingStep.style.display = 'none';
                
                if (success) {
                    const item = getItemById(claimState.itemId);
                    if (successStep) successStep.style.display = 'block';
                    
                    // Add notification
                    addNotification({
                        type: 'system',
                        title: 'Claim Submitted',
                        text: `Your State ID was verified for ${item ? item.title : 'the item'}. The finder will be notified.`
                    });
                } else {
                    if (failedStep) failedStep.style.display = 'block';
                }
            }, 1500);
        }

        function retryClaimVerification() {
            const failedStep = $('claimStepFailed');
            const formStep = $('claimStepForm');
            if (failedStep) failedStep.style.display = 'none';
            if (formStep) formStep.style.display = 'block';
        }

        // Helper functions
        function togglePassword(inputId, btn) {
            const input = $(inputId);
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            btn.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
        }

        function updateUserAvatar() {
            const user = state.currentUser;
            if (user && user.firstName && user.lastName) {
                $('userAvatarBtn').textContent = (user.firstName[0] + user.lastName[0]).toUpperCase();
            }
        }

        function toggleUserMenu() {
            toggle($('userDropdown'));
        }

        function hideUserMenu() {
            hide($('userDropdown'));
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Load notifications from storage
            loadNotificationsFromStorage();
            
            const session = getCookie('session');
            if (session) {
                const userData = getUser();
                if (userData.email === session.email) {
                    state.currentUser = userData;
                    state.isVerified = session.verified;
                    startApp();
                    // Update notification badge after app starts
                    setTimeout(updateNotificationBadge, 100);
                    return;
                }
            }
            
            // Show login section by default
            showLogin();
            
            // Close dropdown and modals when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.user-menu')) {
                    hide($('userDropdown'));
                }
                
                // Close modals when clicking outside
                const newConversationModal = $('newConversationModal');
                const claimModal = $('claimModal');
                
                if (newConversationModal && e.target === newConversationModal) {
                    closeNewConversationModal();
                }
                
                if (claimModal && e.target === claimModal) {
                    closeClaimModal();
                }
            });
            
            // Handle escape key for modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const newConversationModal = $('newConversationModal');
                    const claimModal = $('claimModal');
                    
                    if (newConversationModal && newConversationModal.classList.contains('active')) {
                        closeNewConversationModal();
                    }
                    
                    if (claimModal && claimModal.classList.contains('active')) {
                        closeClaimModal();
                    }
                }
            });
        });

        // App functions
        function startApp() {
            hide($('auth-section'));
            hide($('verification-section'));
            show($('app-section'));
            updateUserAvatar();
            showPage('dashboard');
        }

        function showPage(page) {
            state.currentPage = page;
            const titleEl = $('page-title');
            if (titleEl) titleEl.textContent = page.charAt(0).toUpperCase() + page.slice(1);
            
            // Update nav
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            const navLink = document.querySelector(`[onclick="showPage('${page}')"]`);
            if (navLink) navLink.classList.add('active');
            
            // Load page content
            loadPageContent(page);
        }

        function loadPageContent(page) {
            const content = $('main-content');
            if (!content) return;
            
            const pages = {
                dashboard: getDashboardContent(),
                securefind: getSecureFindContent(),
                easytask: getEasyTaskContent(),
                messages: getMessagesContent(),
                notifications: getNotificationsContent(),
                profile: getProfileContent()
            };
            
            content.innerHTML = pages[page] || '<div class="text-center">Page not found</div>';
            
            // Initialize page-specific functionality
            if (page === 'messages') {
                initializeMessages();
            } else if (page === 'notifications') {
                initializeNotifications();
            } else if (page === 'dashboard') {
                initializeDashboard();
            }
        }

        function getDashboardContent() {
            const user = state.currentUser || {};
            const lostItems = dashboardData.recentSecureFindItems.filter(item => item.status === 'lost').length;
            const foundItems = dashboardData.recentSecureFindItems.filter(item => item.status === 'found').length;
            const pendingTasks = dashboardData.upcomingTasks.filter(task => !task.completed).length;
            
            return `
                <div class="status-card mb-lg">
                    <h3>Welcome back, ${user.firstName || 'User'}!</h3>
                    <p>Your identity is verified. Access all features securely.</p>
                </div>
                
                <div class="action-grid">
                    <div class="action-card" onclick="showPage('securefind')">
                        <div style="font-size: 2rem; margin-bottom: var(--spacing-md); text-align: center;">üì±</div>
                        <h4>Report Lost Item</h4>
                        <p>Lost something? Let the community help find it</p>
                    </div>
                    <div class="action-card" onclick="showPage('easytask')">
                        <div style="font-size: 2rem; margin-bottom: var(--spacing-md); text-align: center;">‚ûï</div>
                        <h4>Add Task</h4>
                        <p>Create a new task to stay organized</p>
                    </div>
                    <div class="action-card" onclick="showPage('messages')">
                        <div style="font-size: 2rem; margin-bottom: var(--spacing-md); text-align: center;">üí¨</div>
                        <h4>Messages</h4>
                        <p>Check your conversations and updates</p>
                    </div>
                </div>

                <div class="dashboard-widgets">
                    <div class="widget-card">
                        <div class="widget-header">
                            <h3 class="widget-title">Recent SecureFind Activity</h3>
                            <a href="#" class="widget-view-all" onclick="showPage('securefind')">View All ‚Üí</a>
                        </div>
                        <div class="widget-content" id="securefind-widget"></div>
                    </div>
                    <div class="widget-card">
                        <div class="widget-header">
                            <h3 class="widget-title">Upcoming Tasks</h3>
                            <a href="#" class="widget-view-all" onclick="showPage('easytask')">View All ‚Üí</a>
                        </div>
                        <div class="widget-content" id="tasks-widget"></div>
                    </div>
                </div>

                <div class="dashboard-widgets" style="margin-top: var(--spacing-lg);">
                    <div class="widget-card">
                        <div class="widget-header">
                            <h3 class="widget-title">Quick Stats</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-lg); text-align: center;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">${lostItems}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Lost Items</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);">${foundItems}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Found Items</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning-color);">${pendingTasks}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Pending Tasks</div>
                            </div>
                        </div>
                    </div>
                    <div class="widget-card">
                        <div class="widget-header">
                            <h3 class="widget-title">Recent Notifications</h3>
                            <a href="#" class="widget-view-all" onclick="showPage('notifications')">View All ‚Üí</a>
                        </div>
                        <div class="widget-content" id="notifications-widget"></div>
                    </div>
                </div>
            `;
        }

        function getSecureFindContent() {
            return `
                <div style="background: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                    <input type="text" placeholder="Search items..." style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border-color); border-radius: var(--border-radius);">
                </div>
                <div class="items-grid">
                    <div class="item-card">
                        <div style="font-size: 2rem; text-align: center; margin-bottom: var(--spacing-md);">üì±</div>
                        <h4>iPhone 15 Pro</h4>
                        <p>üìç Downtown Coffee Shop</p>
                        <p>Lost 2 hours ago</p>
                    </div>
                    <div class="item-card">
                        <div style="font-size: 2rem; text-align: center; margin-bottom: var(--spacing-md);">üí≥</div>
                        <h4>Blue Wallet</h4>
                        <p>üìç Central Park</p>
                        <p>Found 6 hours ago</p>
                        <div style="margin-top: var(--spacing-sm);">
                            <button class="btn-secondary" onclick="openClaimModal('item2')">Claim Item</button>
                        </div>
                    </div>
                    <div class="item-card">
                        <div style="font-size: 2rem; text-align: center; margin-bottom: var(--spacing-md);">üéí</div>
                        <h4>Black Backpack</h4>
                        <p>üìç University Campus</p>
                        <p>Lost 3 days ago</p>
                    </div>
                </div>
            `;
        }

        function getEasyTaskContent() {
            return `
                <div style="background: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); text-align: center;">
                    <button class="btn-primary" onclick="alert('Add task feature coming soon!')">+ Add Task</button>
                </div>
                <div class="task-item" style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <input type="checkbox">
                    <div style="flex: 1;">
                        <h4>Review SecureFind matches</h4>
                        <p>Check potential matches and respond to messages</p>
                    </div>
                </div>
                <div class="task-item" style="display: flex; align-items: center; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                    <input type="checkbox">
                    <div style="flex: 1;">
                        <h4>Update profile information</h4>
                        <p>Complete your profile details for better verification</p>
                    </div>
                </div>
            `;
        }

        function getMessagesContent() {
            return `
                <div class="messages-container">
                    <aside class="messages-sidebar">
                        <button class="new-conversation-btn" onclick="openNewConversationModal()">+ New Conversation</button>
                        <div style="margin-bottom: var(--spacing-md);">
                            <input type="text" id="contactSearch" placeholder="Search conversations..." style="width: 100%; padding: var(--spacing-sm); border: 2px solid var(--border-color); border-radius: var(--border-radius); margin: 0;">
                        </div>
                        <div id="chatList" class="chat-list"></div>
                    </aside>
                    <section class="messages-thread">
                        <div id="threadHeader" class="thread-header">
                            <div class="empty-chat">
                                <div class="empty-chat-icon">üí¨</div>
                                <h3>Select a conversation</h3>
                                <p>Choose a conversation from the left to start messaging</p>
                            </div>
                        </div>
                        <div id="messagesList" class="messages-list" style="display: none;"></div>
                        <form id="messageForm" class="message-form" onsubmit="sendMessage(event)" style="display: none;">
                            <textarea id="messageInput" class="message-input" placeholder="Type a message..." rows="1"></textarea>
                            <button type="submit" class="send-btn" id="sendBtn" disabled>Send</button>
                        </form>
                    </section>
                </div>
                <div id="newConversationModal" class="new-conversation-modal">
                    <div class="new-conversation-form">
                        <h3>Start New Conversation</h3>
                        <div class="form-group">
                            <label for="contactNameInput">Search for people</label>
                            <input type="text" id="contactNameInput" placeholder="Type a name..." style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border-color); border-radius: var(--border-radius);">
                            <div id="contactSuggestions" class="contact-suggestions" style="display: none;"></div>
                        </div>
                        <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-lg);">
                            <button type="button" class="btn-secondary" onclick="closeNewConversationModal()">Cancel</button>
                            <button type="button" class="btn-primary" id="startConversationBtn" onclick="startNewConversation()" disabled>Start Conversation</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getNotificationsContent() {
            return `
                <div class="notifications-wrapper">
                    <div class="notifications-header">
                        <div>
                            <h3>Notifications</h3>
                            <p id="unreadCount" style="color: var(--text-secondary); margin-top: var(--spacing-xs);"></p>
                        </div>
                        <div class="notifications-actions">
                            <button class="btn-secondary" onclick="markAllNotificationsRead()">Mark All Read</button>
                            <button class="btn-secondary" onclick="clearReadNotifications()">Clear Read</button>
                        </div>
                    </div>
                    <div style="margin-bottom: var(--spacing-md);">
                        <input type="text" id="notificationSearch" placeholder="Search notifications..." style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border-color); border-radius: var(--border-radius);">
                    </div>
                    <div id="notificationsList" class="notifications-list"></div>
                    <div id="emptyNotifications" class="empty-notifications" style="display: none;">
                        <div class="empty-notifications-icon">üîî</div>
                        <h3>No notifications</h3>
                        <p>You're all caught up!</p>
                    </div>
                </div>
            `;
        }

        function getProfileContent() {
            const user = state.currentUser || {};
            return `
                <div class="profile-card">
                    <h3 style="text-align: center; margin-bottom: var(--spacing-lg);">Profile Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: var(--spacing-xs);">First Name</div>
                            <div style="font-weight: 600;">${user.firstName || '-'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: var(--spacing-xs);">Last Name</div>
                            <div style="font-weight: 600;">${user.lastName || '-'}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: var(--spacing-xs);">Email</div>
                            <div style="font-weight: 600;">${user.email || '-'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: var(--spacing-xs);">Status</div>
                            <div style="font-weight: 600; color: ${state.isVerified ? 'var(--success-color)' : 'var(--warning-color)'};">${state.isVerified ? 'Verified' : 'Pending'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper functions
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMinutes < 1) return 'Just now';
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        function getTimeUntilDue(dueDate) {
            const now = new Date();
            const diffMs = dueDate - now;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMs < 0) return 'overdue';
            if (diffHours < 1) return 'in less than 1 hour';
            if (diffHours < 24) return `in ${diffHours} hour${diffHours !== 1 ? 's' : ''}`;
            if (diffDays < 7) return `in ${diffDays} day${diffDays !== 1 ? 's' : ''}`;
            return dueDate.toLocaleDateString();
        }

        // Dashboard widget functions
        function initializeDashboard() {
            renderSecureFindWidget();
            renderTasksWidget();
            renderNotificationsWidget();
        }

        function renderSecureFindWidget() {
            const widget = $('securefind-widget');
            if (!widget) return;

            const recentItems = dashboardData.recentSecureFindItems.slice(0, 3);
            
            widget.innerHTML = recentItems.map(item => {
                const timeAgo = getTimeAgo(item.time);
                return `
                    <div class="widget-item" onclick="showPage('securefind')">
                        <div class="widget-item-icon">${item.icon}</div>
                        <div class="widget-item-content">
                            <div class="widget-item-title">${item.title}</div>
                            <div class="widget-item-subtitle">
                                <span>üìç ${item.location}</span>
                                <span class="item-status-badge ${item.status}">${item.status.toUpperCase()}</span>
                            </div>
                            <div class="widget-item-meta">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTasksWidget() {
            const widget = $('tasks-widget');
            if (!widget) return;

            const upcomingTasks = dashboardData.upcomingTasks
                .filter(task => !task.completed)
                .sort((a, b) => a.dueDate - b.dueDate)
                .slice(0, 3);

            widget.innerHTML = upcomingTasks.map(task => {
                const timeUntilDue = getTimeUntilDue(task.dueDate);
                const priorityColor = task.priority === 'high' ? 'var(--error-color)' : 
                                    task.priority === 'medium' ? 'var(--warning-color)' : 'var(--text-secondary)';
                
                return `
                    <div class="widget-item" onclick="showPage('easytask')">
                        <input type="checkbox" class="task-checkbox-widget" onchange="toggleTaskFromDashboard('${task.id}', this.checked)" onclick="event.stopPropagation()">
                        <div class="widget-item-content">
                            <div class="widget-item-title">${task.title}</div>
                            <div class="widget-item-subtitle">${task.description}</div>
                            <div class="widget-item-meta" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Due ${timeUntilDue}</span>
                                <span style="color: ${priorityColor}; font-weight: 500;">${task.priority.toUpperCase()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderNotificationsWidget() {
            const widget = $('notifications-widget');
            if (!widget) return;

            const recentNotifications = notificationData.notifications.slice(0, 3);
            
            widget.innerHTML = recentNotifications.map(notification => {
                const timeAgo = getTimeAgo(notification.time);
                const typeIcon = getNotificationIcon(notification.type);
                
                return `
                    <div class="widget-item" onclick="openNotificationDetail('${notification.id}')">
                        <div class="widget-item-icon" style="background: ${getNotificationColor(notification.type)}; color: white;">
                            ${typeIcon}
                        </div>
                        <div class="widget-item-content">
                            <div class="widget-item-title">${notification.title}</div>
                            <div class="widget-item-subtitle">${notification.text}</div>
                            <div class="widget-item-meta">${timeAgo}</div>
                        </div>
                        ${!notification.read ? '<div style="width: 8px; height: 8px; border-radius: 50%; background: var(--accent-color); flex-shrink: 0;"></div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleTaskFromDashboard(taskId, completed) {
            const task = dashboardData.upcomingTasks.find(t => t.id === taskId);
            if (task) {
                task.completed = completed;
                setTimeout(() => renderTasksWidget(), 100);
            }
        }

        // Add all missing functions with basic implementations
        function initializeMessages() {
            renderContactList();
        }

        function renderContactList() {
            const chatList = $('chatList');
            if (!chatList) return;
            
            chatList.innerHTML = messageData.contacts.map(contact => `
                <div class="chat-item" onclick="selectContact('${contact.id}')">
                    <div class="chat-name">${contact.name}</div>
                    <div class="chat-preview">${contact.preview}</div>
                    <div class="chat-time">${contact.time}</div>
                </div>
            `).join('');
        }

        function selectContact(contactId) {
            // Basic implementation
            alert('Select contact: ' + contactId);
        }

        function sendMessage(e) {
            e.preventDefault();
            alert('Send message functionality');
        }

        function openNewConversationModal() {
            const modal = $('newConversationModal');
            if (modal) modal.classList.add('active');
        }

        function closeNewConversationModal() {
            const modal = $('newConversationModal');
            if (modal) modal.classList.remove('active');
        }

        function startNewConversation() {
            alert('Start new conversation');
        }

        function initializeNotifications() {
            renderNotifications();
            updateNotificationBadge();
        }

        function renderNotifications() {
            const notificationsList = $('notificationsList');
            if (!notificationsList) return;
            
            notificationsList.innerHTML = '<div class="text-center">Notifications loaded</div>';
        }

        function markAllNotificationsRead() {
            alert('Mark all as read');
        }

        function clearReadNotifications() {
            alert('Clear read notifications');
        }

        function openNotificationDetail(id) {
            alert('Open notification: ' + id);
        }

        function markNotificationRead(id) {
            alert('Mark as read: ' + id);
        }

        function deleteNotification(id) {
            alert('Delete notification: ' + id);
        }

        function getNotificationIcon(type) {
            const icons = { message: 'üí¨', match: '‚ú®', task: 'üìù', system: '‚öôÔ∏è' };
            return icons[type] || 'üì¢';
        }

        function getNotificationColor(type) {
            const colors = {
                message: 'var(--accent-color)',
                match: 'var(--success-color)', 
                task: 'var(--warning-color)',
                system: 'var(--primary-color)'
            };
            return colors[type] || 'var(--text-secondary)';
        }

        function updateNotificationBadge() {
            // Basic implementation
        }

        function saveNotificationsToStorage() {
            localStorage.setItem('veritrustNotifications', JSON.stringify(notificationData.notifications));
        }

        function loadNotificationsFromStorage() {
            const stored = localStorage.getItem('veritrustNotifications');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    notificationData.notifications = parsed.map(notif => ({
                        ...notif,
                        time: new Date(notif.time)
                    }));
                } catch (e) {
                    console.error('Error loading notifications:', e);
                }
            }
        }

        function addNotification({ type = 'system', title, text }) {
            notificationData.notifications.unshift({
                id: 'notif_' + Date.now(),
                type,
                title,
                text,
                time: new Date(),
                read: false,
                actionable: false
            });
            saveNotificationsToStorage();
        }

        function getItemById(itemId) {
            return dashboardData.recentSecureFindItems.find(i => i.id === itemId) || null;
        }

        // ...existing code for auth, verification, claim functions...
    </script>

    <!-- Claim Modal -->
<div id="claimModal" class="modal">
    <div class="modal-content" style="max-width: 560px;">
        <div class="claim-section">
            <h3>Claim Verification</h3>
            <div class="muted" style="margin-top:-8px;">Item: <strong id="claimItemTitle">Item</strong></div>
        </div>

        <!-- Step: Form -->
        <form id="claimStepForm" onsubmit="startClaimVerification(event)">
            <div class="claim-section" style="padding-top:0;">
                <div class="form-group">
                    <label for="claimFullName">Full Name *</label>
                    <input id="claimFullName" type="text" required>
                    <div class="claim-hint">As shown on your State ID</div>
                </div>
                <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label for="claimState">Issuing State *</label>
                        <select id="claimState" required>
                            <option value="">Select state</option>
                            <!-- Minimal subset for brevity -->
                            <option value="CA">California</option>
                            <option value="NY">New York</option>
                            <option value="TX">Texas</option>
                            <option value="FL">Florida</option>
                            <option value="IL">Illinois</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="OH">Ohio</option>
                            <option value="GA">Georgia</option>
                            <option value="NC">North Carolina</option>
                            <option value="MI">Michigan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="claimIdNumber">ID Number *</label>
                        <input id="claimIdNumber" type="text" required>
                    </div>
                </div>
                <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label for="claimExp">Expiration Date *</label>
                        <input id="claimExp" type="date" required>
                    </div>
                    <div class="form-group">
                        <label for="claimIdImage">Upload ID Image *</label>
                        <input id="claimIdImage" type="file" accept="image/*" required>
                        <div class="claim-hint">Image is used only to verify your identity for this claim.</div>
                    </div>
                </div>
                <div class="checkbox-group">
                    <input id="claimConfirm" type="checkbox" required>
                    <label for="claimConfirm">I confirm this is my valid State-issued ID and consent to verification for this claim.</label>
                </div>
            </div>
            <div class="claim-actions">
                <button type="button" class="btn-secondary" onclick="closeClaimModal()">Cancel</button>
                <button type="submit" class="btn-primary">Verify and Submit Claim</button>
            </div>
        </form>

        <!-- Step: Pending -->
        <div id="claimStepPending" style="display:none;">
            <div class="claim-summary">
                <div class="claim-spinner"></div>
                <div>Verifying your State ID...</div>
                <div class="muted" style="margin-top:8px;">This usually takes a few seconds</div>
            </div>
            <div class="claim-actions">
                <button type="button" class="btn-secondary" onclick="closeClaimModal()">Close</button>
            </div>
        </div>

        <!-- Step: Success -->
        <div id="claimStepSuccess" style="display:none;">
            <div class="claim-summary">
                <div class="icon text-success">‚úì</div>
                <h3>Verification Successful</h3>
                <p>Your claim has been submitted to the finder. You may receive a message for handoff details.</p>
            </div>
            <div class="claim-actions">
                <button type="button" class="btn-primary" onclick="closeClaimModal()">Done</button>
            </div>
        </div>

        <!-- Step: Failed -->
        <div id="claimStepFailed" style="display:none;">
            <div class="claim-summary">
                <div class="icon text-error">‚ö†Ô∏è</div>
                <h3>Verification Failed</h3>
                <p>We couldn't verify your State ID. Please check the details and try again.</p>
            </div>
            <div class="claim-actions">
                <button type="button" class="btn-secondary" onclick="retryClaimVerification()">Try Again</button>
                <button type="button" class="btn-primary" onclick="closeClaimModal()">Close</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
