<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeriTrust - Secure Identity Platform</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- Landing/Auth Section -->
    <div id="auth-section" class="container">
        <header class="text-center mb-lg">
            <h1 style="font-size: 3rem; color: var(--primary-color); margin-bottom: var(--spacing-sm); font-weight: 700;">VeriTrust</h1>
            <p style="font-size: 1.2rem; color: var(--text-secondary);">Secure Identity. Trusted Community.</p>
        </header>

        <!-- Login Section -->
        <main id="login-section" class="auth-section">
            <h2>Welcome Back</h2>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group password-field">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                    <button type="button" class="toggle-visibility" onclick="togglePassword('password', this)">üëÅÔ∏è</button>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Log In</button>
                <a href="#" class="forgot-password">Forgot Password?</a>
            </form>
            
            <div class="auth-switch">
                <div class="auth-switch-text">Don't have an account?</div>
                <button class="auth-switch-btn" onclick="showSignup()">Sign up here</button>
            </div>
        </main>

        <!-- Signup Section -->
        <main id="signup-section" class="auth-section hidden">
            <h2>Create Account</h2>
            <div class="verification-notice" style="margin-bottom: var(--spacing-lg);">
                <span>üîí</span>
                <span>Account verification through secure bank connection required</span>
            </div>
            <form onsubmit="signup(event)">
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" required>
                </div>
                <div class="form-group">
                    <label for="signup-first-name">First Name</label>
                    <input type="text" id="signup-first-name" required>
                </div>
                <div class="form-group">
                    <label for="signup-last-name">Last Name</label>
                    <input type="text" id="signup-last-name" required>
                </div>
                <div class="form-group">
                    <label for="signup-phone">Phone Number</label>
                    <input type="tel" id="signup-phone" placeholder="(555) 555-5555" required>
                </div>
                <div class="form-group password-field">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" required>
                    <button type="button" class="toggle-visibility" onclick="togglePassword('signup-password', this)">üëÅÔ∏è</button>
                </div>
                <div class="form-group password-field">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" required>
                    <button type="button" class="toggle-visibility" onclick="togglePassword('confirm-password', this)">üëÅÔ∏è</button>
                </div>
                <div style="display: flex; align-items: flex-start; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                    <input type="checkbox" id="terms" required style="width: auto; margin-top: 2px;">
                    <label for="terms">I agree to use trusted bank verification</label>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Create Account</button>
            </form>
            
            <div class="auth-switch">
                <div class="auth-switch-text">Already have an account?</div>
                <button class="auth-switch-btn" onclick="showLogin()">Sign in here</button>
            </div>
        </main>
    </div>

    <!-- Verification Section -->
    <div id="verification-section" class="container" style="display: none;">
        <header class="verification-header">
            <div class="logo">VeriTrust</div>
            <div class="progress-stepper">
                <div class="step completed">1. Create Account</div>
                <div class="step active">2. Verify Identity</div>
                <div class="step">3. Complete</div>
            </div>
        </header>

        <main class="verification-container">
            <div id="verification-start" class="verification-step active">
                <div class="verification-card">
                    <div class="icon-large">üè¶</div>
                    <h2>Verify Your Identity</h2>
                    <p>Provide your bank information to verify your identity. This creates a trusted profile for community interactions.</p>
                    
                    <div class="security-features">
                        <div class="feature">
                            <span class="icon">üîí</span>
                            <span>Bank-grade security</span>
                        </div>
                        <div class="feature">
                            <span class="icon">üö´</span>
                            <span>No account access</span>
                        </div>
                        <div class="feature">
                            <span class="icon">‚úì</span>
                            <span>One-time verification</span>
                        </div>
                    </div>

                    <button class="btn-primary" onclick="showBankForm()">Connect Your Bank</button>
                    <button class="btn-secondary" onclick="skipVerification()">Skip for Now</button>
                </div>
            </div>

            <div id="verification-form" class="verification-step">
                <div class="verification-card">
                    <div class="icon-large">üè¶</div>
                    <h2>Bank Information Verification</h2>
                    <p>Please provide the following information to verify your identity:</p>
                    
                    <form id="bankVerificationForm" class="bank-form">
                        <div class="form-group">
                            <label for="bank-name">Bank Name *</label>
                            <select id="bank-name" required>
                                <option value="">Select your bank</option>
                                <option value="chase">Chase Bank</option>
                                <option value="bofa">Bank of America</option>
                                <option value="wells">Wells Fargo</option>
                                <option value="citi">Citibank</option>
                                <option value="usbank">US Bank</option>
                                <option value="pnc">PNC Bank</option>
                                <option value="td">TD Bank</option>
                                <option value="capital">Capital One</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="account-month">Account Opened Month *</label>
                                <select id="account-month" required>
                                    <option value="">Month</option>
                                    <option value="01">January</option>
                                    <option value="02">February</option>
                                    <option value="03">March</option>
                                    <option value="04">April</option>
                                    <option value="05">May</option>
                                    <option value="06">June</option>
                                    <option value="07">July</option>
                                    <option value="08">August</option>
                                    <option value="09">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="account-year">Account Opened Year *</label>
                                <select id="account-year" required>
                                    <option value="">Year</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="account-type">Account Type *</label>
                            <select id="account-type" required>
                                <option value="">Select account type</option>
                                <option value="checking">Checking</option>
                                <option value="savings">Savings</option>
                                <option value="both">Both Checking & Savings</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="zip-code">ZIP Code (where account was opened) *</label>
                            <input type="text" id="zip-code" maxlength="5" pattern="[0-9]{5}" placeholder="12345" required>
                        </div>

                        <div class="form-group">
                            <label for="routing-number">Bank Routing Number *</label>
                            <input type="text" id="routing-number" maxlength="9" pattern="[0-9]{9}" placeholder="123456789" required>
                        </div>

                        <div class="form-group">
                            <label for="phone-last4">Last 4 digits of phone number *</label>
                            <input type="text" id="phone-last4" maxlength="4" pattern="[0-9]{4}" placeholder="1234" required>
                        </div>

                        <div class="verification-notice">
                            <span class="icon">üîí</span>
                            Your information is encrypted and used only for identity verification
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="showVerificationStep('verification-start')">Back</button>
                            <button type="submit" class="btn-primary">Verify Identity</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Verification (auto-run for most logins) -->
            <div id="quick-verification" class="verification-step">
                <div class="verification-card">
                    <div class="spinner"></div>
                    <h2>Quick Verification</h2>
                    <p>Performing quick checks to secure your session...</p>
                    <div class="status-indicator pending">In Progress</div>
                </div>
            </div>

            <div id="verification-pending" class="verification-step">
                <div class="verification-card">
                    <div class="spinner"></div>
                    <h2>Verifying...</h2>
                    <p>Please wait while we verify your identity through your bank connection.</p>
                    <div class="status-indicator pending">In Progress</div>
                </div>
            </div>

            <div id="verification-success" class="verification-step">
                <div class="verification-card">
                    <div class="icon-large success">‚úì</div>
                    <h2>Verification Successful!</h2>
                    <p>Your identity has been verified. You now have access to all VeriTrust community features.</p>
                    
                    <div class="verified-badge">
                        <span class="badge-icon">‚úì</span>
                        <span>Verified User</span>
                    </div>

                    <button class="btn-primary" onclick="goToDashboard()">Go to Dashboard</button>
                </div>
            </div>

            <div id="verification-failed" class="verification-step">
                <div class="verification-card">
                    <div class="icon-large error">‚ö†Ô∏è</div>
                    <h2>Verification Failed</h2>
                    <p>We couldn't verify your identity at this time. Please try again or contact support.</p>
                    
                    <div class="error-banner">
                        Unable to connect to your bank. Please check your credentials and try again.
                    </div>

                    <button class="btn-primary" onclick="retryVerification()">Try Again</button>
                    <button class="btn-secondary" onclick="contactSupport()">Contact Support</button>
                </div>
            </div>
        </main>
    </div>

    <!-- App Container -->
    <div id="app-section" class="app-container hidden">
        <nav class="sidebar">
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: var(--spacing-xl);">VeriTrust</div>
            <div class="nav-links">
                <a href="#" class="nav-link active" onclick="showPage('dashboard')">
                    <span>üè†</span>Dashboard
                </a>
                <a href="#" class="nav-link" onclick="showPage('securefind')">
                    <span>üîç</span>SecureFind
                </a>
                <a href="#" class="nav-link" onclick="showPage('easytask')">
                    <span>üìù</span>EasyTask
                </a>
                <a href="#" class="nav-link" onclick="showPage('messages')">
                    <span>üí¨</span>Messages
                </a>
                <a href="#" class="nav-link" onclick="showPage('profile')">
                    <span>üë§</span>Profile
                </a>
            </div>
        </nav>

        <!-- Page Content Container -->
        <div class="page-content">
            <header class="top-bar">
                <h1 id="page-title">Dashboard</h1>
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div class="verified-badge" id="verifiedBadge">
                        <span>‚úì</span>
                        <span>Verified</span>
                    </div>
                    <button onclick="showPage('notifications')">üîî</button>
                    <div class="user-menu">
                        <button class="user-avatar" id="userAvatarBtn" onclick="toggleUserMenu()">--</button>
                        <div id="userDropdown" class="user-dropdown hidden">
                            <button onclick="showPage('profile'); hideUserMenu()">üë§ Profile</button>
                            <button onclick="logout(); hideUserMenu()">üö™ Log Out</button>
                        </div>
                    </div>
                </div>
            </header>

            <main class="main-content" id="main-content">
                <!-- Dynamic content loaded here -->
            </main>
        </div>
    </div>

    <script>
        // Simplified state management
        const state = {
            currentUser: null,
            isVerified: false,
            currentPage: 'dashboard'
        };

        // Utility functions
        const $ = id => document.getElementById(id);
        const show = el => el.classList.remove('hidden');
        const hide = el => el.classList.add('hidden');
        const toggle = el => el.classList.toggle('hidden');

        // Cookie management
        function setCookie(name, value, days = 7) {
            const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toUTCString();
            document.cookie = `${name}=${JSON.stringify(value)};expires=${expires};path=/;SameSite=Strict`;
        }

        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? JSON.parse(match[2]) : null;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
        }

        // Storage helpers
        const getUser = () => JSON.parse(localStorage.getItem('veritrustUser') || '{}');
        const setUser = data => localStorage.setItem('veritrustUser', JSON.stringify(data));

        // Auth functions
        function showLogin() {
            hide($('signup-section'));
            show($('login-section'));
            // Clear signup form
            $('signup-section').querySelector('form').reset();
        }

        function showSignup() {
            hide($('login-section'));
            show($('signup-section'));
            // Clear login form
            $('login-section').querySelector('form').reset();
        }

        function login(e) {
            e.preventDefault();
            const email = $('email').value.trim();
            const password = $('password').value;
            const userData = getUser();
            
            if (!userData.email || userData.email !== email || userData.password !== password) {
                return alert('Invalid credentials');
            }
            
            state.currentUser = userData;
            setCookie('session', { email, verified: userData.verified });
            startApp();
        }

        function signup(e) {
            e.preventDefault();
            const email = $('signup-email').value.trim();
            const firstName = $('signup-first-name').value.trim();
            const lastName = $('signup-last-name').value.trim();
            const phone = $('signup-phone').value.trim();
            const password = $('signup-password').value;
            const confirmPassword = $('confirm-password').value;
            const terms = $('terms').checked;
            
            if (!email || !firstName || !lastName || !phone || !password || !confirmPassword) {
                return alert('Please fill in all fields');
            }
            
            if (password !== confirmPassword) {
                return alert('Passwords do not match');
            }
            
            if (!terms) {
                return alert('Please accept the terms');
            }
            
            if (getUser().email === email) {
                return alert('User already exists');
            }
            
            const userData = {
                email,
                firstName,
                lastName,
                phone,
                password,
                verified: false,
                signupDate: new Date().toISOString()
            };
            
            setUser(userData);
            alert('Account created! Please login.');
            showLogin();
            $('email').value = email; // Pre-fill email on login form
        }

        // App functions
        function startApp() {
            hide($('auth-section'));
            show($('app-section'));
            updateUserAvatar();
            showPage('dashboard');
        }

        function showPage(page) {
            state.currentPage = page;
            $('page-title').textContent = page.charAt(0).toUpperCase() + page.slice(1);
            
            // Update nav
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`[onclick="showPage('${page}')"]`).classList.add('active');
            
            // Load page content
            loadPageContent(page);
        }

        function loadPageContent(page) {
            const content = $('main-content');
            const pages = {
                dashboard: `
                    <div class="status-card mb-lg">
                        <h3>Welcome back!</h3>
                        <p>Your identity is verified. Access all features securely.</p>
                    </div>
                    <div class="action-grid">
                        <div class="action-card" onclick="showPage('securefind')">
                            <div style="font-size: 2rem; margin-bottom: var(--spacing-md); text-align: center;">üì±</div>
                            <h4>Report Lost Item</h4>
                            <p>Lost something? Let the community help find it</p>
                        </div>
                        <div class="action-card" onclick="showPage('easytask')">
                            <div style="font-size: 2rem; margin-bottom: var(--spacing-md); text-align: center;">‚ûï</div>
                            <h4>Add Task</h4>
                            <p>Create a new task to stay organized</p>
                        </div>
                    </div>
                `,
                securefind: `
                    <div style="background: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                        <input type="text" placeholder="Search items..." style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border-color); border-radius: var(--border-radius);">
                    </div>
                    <div class="items-grid">
                        <div class="item-card">
                            <div style="font-size: 2rem; text-align: center; margin-bottom: var(--spacing-md);">üì±</div>
                            <h4>iPhone 15 Pro</h4>
                            <p>üìç Downtown Coffee Shop</p>
                            <p>Lost 2 hours ago</p>
                        </div>
                        <div class="item-card">
                            <div style="font-size: 2rem; text-align: center; margin-bottom: var(--spacing-md);">üí≥</div>
                            <h4>Blue Wallet</h4>
                            <p>üìç Central Park</p>
                            <p>Found 6 hours ago</p>
                        </div>
                        <div class="item-card">
                            <div style="font-size: 2rem; text-align: center; margin-bottom: var(--spacing-md);">üéí</div>
                            <h4>Black Backpack</h4>
                            <p>üìç University Campus</p>
                            <p>Lost 3 days ago</p>
                        </div>
                    </div>
                `,
                easytask: `
                    <div style="background: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); text-align: center;">
                        <button class="btn-primary" onclick="alert('Add task feature coming soon!')">+ Add Task</button>
                    </div>
                    <div class="task-item" style="display: flex; align-items: center; gap: var(--spacing-md);">
                        <input type="checkbox">
                        <div style="flex: 1;">
                            <h4>Review SecureFind matches</h4>
                            <p>Check potential matches and respond to messages</p>
                        </div>
                    </div>
                    <div class="task-item" style="display: flex; align-items: center; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                        <input type="checkbox">
                        <div style="flex: 1;">
                            <h4>Update profile information</h4>
                            <p>Complete your profile details for better verification</p>
                        </div>
                    </div>
                `,
                messages: `
                    <div class="messages-container">
                        <aside class="messages-sidebar">
                            <button class="new-conversation-btn" onclick="openNewConversationModal()">
                                + New Conversation
                            </button>
                            <div style="margin-bottom: var(--spacing-md);">
                                <input type="text" id="contactSearch" class="form-group input" placeholder="Search conversations..." style="width: 100%; padding: var(--spacing-sm); border: 2px solid var(--border-color); border-radius: var(--border-radius); margin: 0;">
                            </div>
                            <div id="chatList" class="chat-list">
                                <!-- Chat items will be populated here -->
                            </div>
                        </aside>
                        <section class="messages-thread">
                            <div id="threadHeader" class="thread-header">
                                <div class="empty-chat">
                                    <div class="empty-chat-icon">üí¨</div>
                                    <h3>Select a conversation</h3>
                                    <p>Choose a conversation from the left to start messaging</p>
                                </div>
                            </div>
                            <div id="messagesList" class="messages-list" style="display: none;">
                                <!-- Messages will be populated here -->
                            </div>
                            <form id="messageForm" class="message-form" onsubmit="sendMessage(event)" style="display: none;">
                                <textarea id="messageInput" class="message-input" placeholder="Type a message..." rows="1"></textarea>
                                <button type="submit" class="send-btn" id="sendBtn" disabled>Send</button>
                            </form>
                        </section>
                    </div>
                    
                    <!-- New Conversation Modal -->
                    <div id="newConversationModal" class="new-conversation-modal">
                        <div class="new-conversation-form">
                            <h3>Start New Conversation</h3>
                            <div class="form-group">
                                <label for="contactNameInput">Search for people</label>
                                <input type="text" id="contactNameInput" placeholder="Type a name..." style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border-color); border-radius: var(--border-radius);">
                                <div id="contactSuggestions" class="contact-suggestions" style="display: none;">
                                    <!-- Contact suggestions will be populated here -->
                                </div>
                            </div>
                            <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-lg);">
                                <button type="button" class="btn-secondary" onclick="closeNewConversationModal()">Cancel</button>
                                <button type="button" class="btn-primary" id="startConversationBtn" onclick="startNewConversation()" disabled>Start Conversation</button>
                            </div>
                        </div>
                    </div>
                `,
                profile: `
                    <div class="profile-card">
                        <h3 style="text-align: center; margin-bottom: var(--spacing-lg);">Profile Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: var(--spacing-xs);">First Name</div>
                                <div style="font-weight: 600;">${state.currentUser?.firstName || '-'}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: var(--spacing-xs);">Last Name</div>
                                <div style="font-weight: 600;">${state.currentUser?.lastName || '-'}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: var(--spacing-xs);">Email</div>
                                <div style="font-weight: 600;">${state.currentUser?.email || '-'}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: var(--spacing-xs);">Status</div>
                                <div style="font-weight: 600; color: ${state.isVerified ? 'var(--success-color)' : 'var(--warning-color)'};">${state.isVerified ? 'Verified' : 'Pending'}</div>
                            </div>
                        </div>
                    </div>
                `
            };
            
            content.innerHTML = pages[page] || '<div class="text-center">Page not found</div>';
            
            // Initialize messages if on messages page
            if (page === 'messages') {
                initializeMessages();
            }
        }

        // Sample message data
        const messageData = {
            contacts: [
                {
                    id: 'contact1',
                    name: 'Sarah Johnson',
                    preview: 'Thanks for helping me find my wallet!',
                    time: '2 min ago',
                    messages: [
                        { text: 'Hi! I saw your post about finding a blue wallet in Central Park', sent: false, time: '10:30 AM' },
                        { text: 'Yes! I found it near the fountain. Can you describe what was inside?', sent: true, time: '10:32 AM' },
                        { text: 'It has my driver\'s license and a Chase credit card', sent: false, time: '10:33 AM' },
                        { text: 'Perfect! That matches. When would you like to meet up?', sent: true, time: '10:35 AM' },
                        { text: 'Thanks for helping me find my wallet!', sent: false, time: '10:40 AM' }
                    ]
                },
                {
                    id: 'contact2',
                    name: 'Mike Chen',
                    preview: 'Is the iPhone still available?',
                    time: '1 hour ago',
                    messages: [
                        { text: 'Hi, I lost my iPhone in the downtown area. Is it still available?', sent: false, time: '9:15 AM' },
                        { text: 'Yes it is! Can you tell me the model and color?', sent: true, time: '9:20 AM' },
                        { text: 'iPhone 15 Pro, blue color with a clear case', sent: false, time: '9:22 AM' },
                        { text: 'Is the iPhone still available?', sent: false, time: '9:45 AM' }
                    ]
                },
                {
                    id: 'contact3',
                    name: 'Alex Rivera',
                    preview: 'Let me know if you need any other details',
                    time: '3 hours ago',
                    messages: [
                        { text: 'I found a black backpack near the university. Is it yours?', sent: true, time: '7:30 AM' },
                        { text: 'Yes! That sounds like mine. It has a laptop inside?', sent: false, time: '7:35 AM' },
                        { text: 'Yes, and some textbooks. Where would you like to meet?', sent: true, time: '7:37 AM' },
                        { text: 'Let me know if you need any other details', sent: false, time: '7:50 AM' }
                    ]
                }
            ],
            currentContact: null,
            availableContacts: [
                { id: 'new1', name: 'Emma Wilson', context: 'Posted about lost keys in downtown area' },
                { id: 'new2', name: 'David Lee', context: 'Found a wallet near the metro station' },
                { id: 'new3', name: 'Lisa Garcia', context: 'Looking for lost phone in Central Park' },
                { id: 'new4', name: 'Tom Anderson', context: 'Found reading glasses at the library' },
                { id: 'new5', name: 'Maria Rodriguez', context: 'Posted about missing laptop bag' }
            ]
        };

        function initializeMessages() {
            renderContactList();
            setupMessageInput();
            
            // Auto-expand textarea
            const messageInput = $('messageInput');
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                    
                    // Enable/disable send button
                    const sendBtn = $('sendBtn');
                    sendBtn.disabled = !this.value.trim();
                });
                
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (this.value.trim()) {
                            sendMessage(e);
                        }
                    }
                });
            }
        }

        function renderContactList() {
            const chatList = $('chatList');
            if (!chatList) return;
            
            chatList.innerHTML = messageData.contacts.map(contact => `
                <div class="chat-item" onclick="selectContact('${contact.id}')">
                    <div class="chat-name">${contact.name}</div>
                    <div class="chat-preview">${contact.preview}</div>
                    <div class="chat-time">${contact.time}</div>
                </div>
            `).join('');
        }

        function selectContact(contactId) {
            const contact = messageData.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            messageData.currentContact = contact;
            
            // Update UI
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.chat-item').classList.add('active');
            
            // Update thread header
            const threadHeader = $('threadHeader');
            threadHeader.innerHTML = `${contact.name}`;
            threadHeader.className = 'thread-header';
            
            // Show messages area and form
            $('messagesList').style.display = 'flex';
            $('messageForm').style.display = 'flex';
            
            // Render messages
            renderMessages(contact.messages);
        }

        function renderMessages(messages) {
            const messagesList = $('messagesList');
            if (!messagesList) return;
            
            messagesList.innerHTML = messages.map(message => `
                <div class="message-group ${message.sent ? 'sent' : 'received'}">
                    <div class="message-bubble">${message.text}</div>
                    <div class="message-time">${message.time}</div>
                </div>
            `).join('');
            
            // Scroll to bottom
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        function sendMessage(e) {
            e.preventDefault();
            const messageInput = $('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !messageData.currentContact) return;
            
            // Add message to current contact
            const newMessage = {
                text: message,
                sent: true,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };
            
            messageData.currentContact.messages.push(newMessage);
            
            // Update contact preview
            messageData.currentContact.preview = message;
            messageData.currentContact.time = 'Just now';
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            $('sendBtn').disabled = true;
            
            // Re-render
            renderMessages(messageData.currentContact.messages);
            renderContactList();
            
            // Simulate response after 2 seconds
            setTimeout(() => {
                if (messageData.currentContact) {
                    const responses = [
                        "Thanks for the message!",
                        "Got it, I'll be there soon.",
                        "Perfect, see you then!",
                        "Thank you so much for your help!",
                        "That works for me."
                    ];
                    
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    const responseMessage = {
                        text: randomResponse,
                        sent: false,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    };
                    
                    messageData.currentContact.messages.push(responseMessage);
                    messageData.currentContact.preview = randomResponse;
                    messageData.currentContact.time = 'Just now';
                    
                    renderMessages(messageData.currentContact.messages);
                    renderContactList();
                }
            }, 2000);
        }

        function setupMessageInput() {
            const contactSearch = $('contactSearch');
            if (contactSearch) {
                contactSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const chatItems = document.querySelectorAll('.chat-item');
                    
                    chatItems.forEach(item => {
                        const name = item.querySelector('.chat-name').textContent.toLowerCase();
                        const preview = item.querySelector('.chat-preview').textContent.toLowerCase();
                        
                        if (name.includes(searchTerm) || preview.includes(searchTerm)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        }

        // New conversation functions
        let selectedNewContact = null;

        function openNewConversationModal() {
            $('newConversationModal').classList.add('active');
            $('contactNameInput').focus();
            setupContactSearch();
        }

        function closeNewConversationModal() {
            $('newConversationModal').classList.remove('active');
            $('contactNameInput').value = '';
            $('contactSuggestions').style.display = 'none';
            $('startConversationBtn').disabled = true;
            selectedNewContact = null;
        }

        function setupContactSearch() {
            const contactInput = $('contactNameInput');
            const suggestions = $('contactSuggestions');
            const startBtn = $('startConversationBtn');
            
            contactInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                if (searchTerm.length === 0) {
                    suggestions.style.display = 'none';
                    startBtn.disabled = true;
                    selectedNewContact = null;
                    return;
                }
                
                const filteredContacts = messageData.availableContacts.filter(contact => 
                    contact.name.toLowerCase().includes(searchTerm) &&
                    !messageData.contacts.find(existing => existing.name === contact.name)
                );
                
                if (filteredContacts.length > 0) {
                    suggestions.innerHTML = filteredContacts.map(contact => `
                        <div class="contact-suggestion" onclick="selectNewContact('${contact.id}')">
                            <div class="suggestion-name">${contact.name}</div>
                            <div class="suggestion-context">${contact.context}</div>
                        </div>
                    `).join('');
                    suggestions.style.display = 'block';
                } else {
                    suggestions.innerHTML = '<div class="contact-suggestion" style="color: var(--text-secondary); cursor: default;">No contacts found</div>';
                    suggestions.style.display = 'block';
                }
            });
        }

        function selectNewContact(contactId) {
            const contact = messageData.availableContacts.find(c => c.id === contactId);
            if (!contact) return;
            
            selectedNewContact = contact;
            $('contactNameInput').value = contact.name;
            $('contactSuggestions').style.display = 'none';
            $('startConversationBtn').disabled = false;
        }

        function startNewConversation() {
            if (!selectedNewContact) return;
            
            // Create new conversation
            const newConversation = {
                id: 'contact_' + Date.now(),
                name: selectedNewContact.name,
                preview: 'New conversation',
                time: 'Just now',
                messages: []
            };
            
            // Add to contacts list
            messageData.contacts.unshift(newConversation);
            
            // Remove from available contacts
            messageData.availableContacts = messageData.availableContacts.filter(
                c => c.id !== selectedNewContact.id
            );
            
            // Close modal
            closeNewConversationModal();
            
            // Re-render contact list
            renderContactList();
            
            // Auto-select the new conversation
            selectContact(newConversation.id);
        }

        // Helper functions
        function togglePassword(inputId, btn) {
            const input = $(inputId);
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            btn.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
        }

        function updateUserAvatar() {
            const user = state.currentUser;
            if (user && user.firstName && user.lastName) {
                $('userAvatarBtn').textContent = (user.firstName[0] + user.lastName[0]).toUpperCase();
            }
        }

        function toggleUserMenu() {
            toggle($('userDropdown'));
        }

        function hideUserMenu() {
            hide($('userDropdown'));
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            const session = getCookie('session');
            if (session) {
                const userData = getUser();
                if (userData.email === session.email) {
                    state.currentUser = userData;
                    state.isVerified = session.verified;
                    startApp();
                    return;
                }
            }
            
            // Show login section by default
            showLogin();
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.user-menu')) {
                    hide($('userDropdown'));
                }
                
                // Close new conversation modal when clicking outside
                const modal = $('newConversationModal');
                if (modal && e.target === modal) {
                    closeNewConversationModal();
                }
            });
            
            // Handle escape key for modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = $('newConversationModal');
                    if (modal && modal.classList.contains('active')) {
                        closeNewConversationModal();
                    }
                }
            });
        });
    </script>
</body>
</html>
